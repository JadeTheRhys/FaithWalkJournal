<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - FaithWalk Journal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      --earth-dark: #3e2723;
      --earth-medium: #5d4037;
      --earth-light: #8d6e63;
      --sand: #d7ccc8;
      --cream: #efebe9;
      --warm-white: #fafaf8;
      --sage: #8a9a5b;
      --olive: #6b7c3f;
      --terracotta: #c17b63;
      --gold: #b8860b;
    }
    
    body { 
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #f5f1e8 0%, #e8dcc4 50%, #d9c9b0 100%);
      color: var(--earth-dark);
    }

    .hidden { display: none !important; }

    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
    }

    .btn-primary {
      background: var(--sage);
      color: white;
    }

    .btn-primary:hover {
      background: var(--olive);
    }

    .btn-success {
      background: #4caf50;
      color: white;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-secondary {
      background: var(--earth-light);
      color: white;
    }

    .card {
      background: white;
      border-radius: 0.5rem;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .post-card {
      border-left: 4px solid var(--sand);
      transition: all 0.2s;
    }

    .post-card.flagged {
      border-left-color: #ff9800;
      background: #fff3e0;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .badge-pending {
      background: #ffc107;
      color: #000;
    }

    .badge-approved {
      background: #4caf50;
      color: white;
    }

    .badge-rejected {
      background: #f44336;
      color: white;
    }

    .severity-high {
      color: #f44336;
      font-weight: bold;
    }

    .severity-medium {
      color: #ff9800;
      font-weight: bold;
    }

    .severity-low {
      color: #2196f3;
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Login Screen -->
  <div id="login-screen" class="flex items-center justify-center min-h-screen">
    <div class="card max-w-md w-full mx-4">
      <h1 class="text-3xl font-bold mb-6 text-center" style="color: var(--earth-medium);">Admin Login</h1>
      <div id="login-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>
      <form id="login-form">
        <div class="mb-4">
          <label class="block text-sm font-medium mb-2">Username</label>
          <input type="text" id="username" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-sage">
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium mb-2">Password</label>
          <input type="password" id="password" required class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-sage">
        </div>
        <button type="submit" class="btn btn-primary w-full">Login</button>
      </form>
      <p class="mt-4 text-sm text-center text-gray-600">Default: admin / changeme123</p>
      <p class="mt-2 text-xs text-center text-red-600 font-semibold">⚠️ Change default password after first login!</p>
    </div>
  </div>

  <!-- Dashboard Screen -->
  <div id="dashboard-screen" class="hidden">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-bold" style="color: var(--earth-medium);">FaithWalk Admin Dashboard</h1>
        <div class="flex gap-4 items-center">
          <span id="admin-username" class="text-sm text-gray-600"></span>
          <button id="logout-btn" class="btn btn-secondary">Logout</button>
        </div>
      </div>
    </header>

    <!-- Stats -->
    <div class="max-w-7xl mx-auto px-4 py-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="card text-center">
          <div class="text-3xl font-bold text-yellow-600" id="stat-pending">0</div>
          <div class="text-sm text-gray-600">Pending</div>
        </div>
        <div class="card text-center">
          <div class="text-3xl font-bold text-green-600" id="stat-approved">0</div>
          <div class="text-sm text-gray-600">Approved</div>
        </div>
        <div class="card text-center">
          <div class="text-3xl font-bold text-red-600" id="stat-rejected">0</div>
          <div class="text-sm text-gray-600">Rejected</div>
        </div>
        <div class="card text-center">
          <div class="text-3xl font-bold" style="color: var(--sage);" id="stat-total">0</div>
          <div class="text-sm text-gray-600">Total</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="flex gap-2 mb-6 border-b" id="tab-buttons">
        <button class="px-4 py-2 font-medium tab-btn active" data-tab="pending">Pending Posts</button>
        <button class="px-4 py-2 font-medium tab-btn" data-tab="approved">Approved Posts</button>
        <button class="px-4 py-2 font-medium tab-btn" data-tab="rejected">Rejected Posts</button>
        <button class="px-4 py-2 font-medium tab-btn" data-tab="filters">Word Filters</button>
        <button class="px-4 py-2 font-medium tab-btn" data-tab="settings">Settings</button>
      </div>

      <!-- Tab Content -->
      <div id="tab-pending" class="tab-content">
        <div id="pending-posts"></div>
      </div>

      <div id="tab-approved" class="tab-content hidden">
        <div id="approved-posts"></div>
      </div>

      <div id="tab-rejected" class="tab-content hidden">
        <div id="rejected-posts"></div>
      </div>

      <div id="tab-filters" class="tab-content hidden">
        <div class="card mb-4">
          <h2 class="text-xl font-bold mb-4">Add New Filter</h2>
          <form id="filter-form" class="flex gap-4">
            <input type="text" id="filter-word" placeholder="Word to filter" required class="flex-1 px-3 py-2 border rounded-md">
            <select id="filter-severity" class="px-3 py-2 border rounded-md">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High (Auto-reject)</option>
            </select>
            <button type="submit" class="btn btn-primary">Add Filter</button>
          </form>
        </div>
        <div id="filters-list"></div>
      </div>

      <div id="tab-settings" class="tab-content hidden">
        <div class="card">
          <h2 class="text-xl font-bold mb-4">Change Password</h2>
          <form id="password-form">
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Current Password</label>
              <input type="password" id="current-password" required class="w-full px-3 py-2 border rounded-md">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">New Password (min 8 characters)</label>
              <input type="password" id="new-password" required minlength="8" class="w-full px-3 py-2 border rounded-md">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium mb-2">Confirm New Password</label>
              <input type="password" id="confirm-password" required class="w-full px-3 py-2 border rounded-md">
            </div>
            <button type="submit" class="btn btn-primary">Change Password</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    'use strict';

    const API_URL = window.location.origin + '/api';
    let authToken = localStorage.getItem('authToken');

    // Login
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(`${API_URL}/admin/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          authToken = data.token;
          localStorage.setItem('authToken', authToken);
          document.getElementById('admin-username').textContent = data.username;
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('dashboard-screen').classList.remove('hidden');
          await loadDashboard();
        } else {
          showLoginError(data.error || 'Login failed');
        }
      } catch (error) {
        showLoginError('Network error. Please try again.');
      }
    });

    function showLoginError(message) {
      const errorDiv = document.getElementById('login-error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    function logout() {
      localStorage.removeItem('authToken');
      authToken = null;
      location.reload();
    }

    // Setup logout button event listener
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', logout);
      }
    });

    // Load dashboard
    async function loadDashboard() {
      await loadStats();
      await loadPosts('pending');
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/admin/stats`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await response.json();

        if (data.success) {
          document.getElementById('stat-pending').textContent = data.stats.pending;
          document.getElementById('stat-approved').textContent = data.stats.approved;
          document.getElementById('stat-rejected').textContent = data.stats.rejected;
          document.getElementById('stat-total').textContent = data.stats.total;
        }
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function loadPosts(status) {
      const container = document.getElementById(`${status}-posts`);
      container.innerHTML = '<p class="text-center">Loading...</p>';

      try {
        const response = await fetch(`${API_URL}/admin/posts?status=${status}`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await response.json();

        if (data.success && data.posts.length > 0) {
          container.innerHTML = data.posts.map(post => createPostCard(post, status)).join('');
          
          // Add event delegation for moderate and delete buttons
          container.querySelectorAll('.moderate-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const postId = parseInt(e.target.dataset.postId);
              const action = e.target.dataset.action;
              moderatePost(postId, action);
            });
          });
          
          container.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const postId = parseInt(e.target.dataset.postId);
              deletePost(postId);
            });
          });
        } else {
          container.innerHTML = '<p class="text-center text-gray-500">No posts found.</p>';
        }
      } catch (error) {
        container.innerHTML = '<p class="text-center text-red-500">Error loading posts.</p>';
      }
    }

    function createPostCard(post, status) {
      const isFlagged = post.flagged_words && post.flagged_words.length > 0;
      const timestamp = new Date(post.timestamp || post.created_at).toLocaleString();

      return `
        <div class="post-card card ${isFlagged ? 'flagged' : ''}" data-post-id="${post.id}">
          <div class="flex justify-between items-start mb-2">
            <span class="badge badge-${post.approval_status}">${post.approval_status}</span>
            <span class="text-sm text-gray-500">${timestamp}</span>
          </div>
          ${isFlagged ? `<div class="text-orange-600 font-medium mb-2">⚠️ Flagged words: ${post.flagged_words}</div>` : ''}
          <p class="mb-4">${escapeHtml(post.content)}</p>
          <div class="flex gap-2">
            ${status === 'pending' ? `
              <button class="btn btn-success moderate-btn" data-post-id="${post.id}" data-action="approve">Approve</button>
              <button class="btn btn-danger moderate-btn" data-post-id="${post.id}" data-action="reject">Reject</button>
            ` : ''}
            <button class="btn btn-danger delete-btn" data-post-id="${post.id}">Delete</button>
          </div>
        </div>
      `;
    }

    async function moderatePost(postId, action) {
      const reason = prompt(`Reason for ${action}ing this post (optional):`);

      try {
        const response = await fetch(`${API_URL}/admin/posts/${postId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ action, reason })
        });

        const data = await response.json();

        if (data.success) {
          alert(`Post ${action}ed successfully!`);
          await loadStats();
          await loadPosts('pending');
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    async function deletePost(postId) {
      if (!confirm('Are you sure you want to delete this post?')) return;

      const reason = prompt('Reason for deletion (optional):');

      try {
        const response = await fetch(`${API_URL}/admin/posts/${postId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.success) {
          alert('Post deleted successfully!');
          await loadStats();
          const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
          await loadPosts(activeTab);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    function showTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
      });
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');

      // Load content
      if (tabName === 'filters') {
        loadFilters();
      } else if (tabName === 'pending' || tabName === 'approved' || tabName === 'rejected') {
        loadPosts(tabName);
      }
    }

    // Setup tab button event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          showTab(btn.dataset.tab);
        });
      });
    });

    async function loadFilters() {
      const container = document.getElementById('filters-list');
      container.innerHTML = '<p class="text-center">Loading...</p>';

      try {
        const response = await fetch(`${API_URL}/admin/filters`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await response.json();

        if (data.success && data.filters.length > 0) {
          container.innerHTML = data.filters.map(filter => `
            <div class="card flex justify-between items-center">
              <div>
                <span class="font-medium">${escapeHtml(filter.word)}</span>
                <span class="ml-4 severity-${filter.severity}">${filter.severity.toUpperCase()}</span>
              </div>
              <button class="btn btn-danger delete-filter-btn" data-filter-id="${filter.id}">Delete</button>
            </div>
          `).join('');
          
          // Add event listeners for delete filter buttons
          container.querySelectorAll('.delete-filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const filterId = parseInt(e.target.dataset.filterId);
              deleteFilter(filterId);
            });
          });
        } else {
          container.innerHTML = '<p class="text-center text-gray-500">No filters found.</p>';
        }
      } catch (error) {
        container.innerHTML = '<p class="text-center text-red-500">Error loading filters.</p>';
      }
    }

    document.getElementById('filter-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const word = document.getElementById('filter-word').value;
      const severity = document.getElementById('filter-severity').value;

      try {
        const response = await fetch(`${API_URL}/admin/filters`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ word, severity })
        });

        const data = await response.json();

        if (data.success) {
          alert('Filter added successfully!');
          document.getElementById('filter-word').value = '';
          await loadFilters();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    });

    async function deleteFilter(filterId) {
      if (!confirm('Are you sure you want to delete this filter?')) return;

      try {
        const response = await fetch(`${API_URL}/admin/filters/${filterId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });

        const data = await response.json();

        if (data.success) {
          alert('Filter deleted successfully!');
          await loadFilters();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Password change form
    document.getElementById('password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        alert('New passwords do not match!');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/admin/change-password`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const data = await response.json();

        if (data.success) {
          alert('Password changed successfully!');
          document.getElementById('password-form').reset();
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        alert('Network error. Please try again.');
      }
    });

    // Auto-login if token exists
    if (authToken) {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('dashboard-screen').classList.remove('hidden');
      loadDashboard().catch(() => {
        logout();
      });
    }

    // Style active tab
    const style = document.createElement('style');
    style.textContent = `
      .tab-btn.active {
        color: var(--sage);
        border-bottom: 2px solid var(--sage);
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
